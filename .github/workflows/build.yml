name: Build Filament matc

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      # ------------------------------------------------------------
      # Checkout (COM submodules)
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ------------------------------------------------------------
      # Dependências do sistema
      # ------------------------------------------------------------
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            ninja-build \
            cmake \
            git \
            python3 \
            python3-pip

      # ------------------------------------------------------------
      # Verificação estrutural (DEBUG)
      # ------------------------------------------------------------
      - name: Debug repository tree
        run: |
          echo "==== ROOT ===="
          ls -la
          echo "==== FILAMENT DIR ===="
          ls -la filament
          echo "==== CMakeLists.txt ===="
          find filament -maxdepth 2 -name CMakeLists.txt

      # ------------------------------------------------------------
      # Configuração do build
      # ------------------------------------------------------------
      - name: Configure Filament (Release)
        run: |
          cmake -S filament -B out/cmake-release \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_CXX_STANDARD_REQUIRED=ON \
            -DCMAKE_CXX_EXTENSIONS=OFF

      # ------------------------------------------------------------
      # Build
      # ------------------------------------------------------------
      - name: Build Filament
        run: |
          cmake --build out/cmake-release --target matc

      # ------------------------------------------------------------
      # Publicar artefato (matc)
      # ------------------------------------------------------------
      - name: Upload matc binary
        uses: actions/upload-artifact@v4
        with:
          name: matc-linux
          path: out/cmake-release/tools/matc/matc
